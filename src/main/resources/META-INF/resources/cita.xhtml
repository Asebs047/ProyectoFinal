<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<h:head>
    <title>Citas</title>
    <h:outputStylesheet library="css" name="app.css"/>
</h:head>

<f:metadata>
    <f:viewParam name="idVehiculo" value="#{citaView.viewParamIdVehiculo}" />
    <f:viewParam name="idCliente" value="#{citaView.viewParamIdCliente}" />
    <!-- Verificar acceso: si hay sesión de cliente, redirigir fuera de esta página (solo administradores deben gestionarla) -->
    <f:viewAction action="#{citaView.asegurarAccesoAdministrador}" />
    <f:viewAction action="#{citaView.prepararNuevaCitaFromParams}" />
</f:metadata>

<h:body>
    <h:form id="growlForm"><p:growl id="growlMensajes" showDetail="true" life="3000"/></h:form>
    <h:form id="toolbarCitas">
        <p:toolbar>
            <p:toolbarGroup>
                <p:commandButton value="Nueva" icon="pi pi-plus" actionListener="#{citaView.agregarCita}" update=":dialogCitaForm" />
            </p:toolbarGroup>
            <p:toolbarGroup align="right">
                <p:commandButton value="Refrescar" icon="pi pi-refresh" actionListener="#{citaView.refresh}" update=":citasForm:tabla"/>
                <p:commandButton value="Inicio" icon="pi pi-home" type="button" onclick="window.location='#{request.contextPath}/AdministradorWeb.html'"/>
            </p:toolbarGroup>
        </p:toolbar>
    </h:form>

    <h:form id="citasForm">
        <!-- Panel: citas pendientes del día -->
        <p:panel header="Citas pendientes hoy" style="margin-bottom:10px">
            <p:dataTable id="pendientesTabla" value="#{citaView.pendientesHoy}" var="ph" emptyMessage="No hay citas pendientes hoy" paginator="true" rows="5" stripedRows="true">
                <p:column headerText="ID" style="width:60px"><h:outputText value="#{ph.id_cita}"/></p:column>
                <p:column headerText="Fecha"><h:outputText value="#{ph.appointmentDate}"/></p:column>
                <p:column headerText="Mecánico"><h:outputText value="#{ph.idEmpleado}"/></p:column>
                <p:column headerText="Cliente"><h:outputText value="#{ph.idCliente}"/></p:column>
                <p:column headerText="Tipo"><h:outputText value="#{ph.appointmentType}"/></p:column>
                <p:column headerText="Vehículo"><h:outputText value="#{ph.idVehiculo}"/></p:column>
                <p:column headerText="Estado"><h:outputText value="#{ph.status}"/></p:column>
            </p:dataTable>
            <p:commandButton value="Refrescar pendientes" icon="pi pi-refresh" actionListener="#{citaView.refreshHoy}" update=":citasForm:pendientesTabla :growlForm:growlMensajes" style="margin-top:8px" />
        </p:panel>

        <p:dataTable id="tabla" value="#{citaView.citas}" var="c" paginator="true" rows="10" rowKey="#{c.id_cita}" emptyMessage="No hay citas" stripedRows="true" rowHover="true">
            <p:column headerText="ID" style="width:60px"><h:outputText value="#{c.id_cita}"/></p:column>
            <p:column headerText="Fecha"><h:outputText value="#{c.appointmentDate}"/></p:column>
            <p:column headerText="Mecánico"><h:outputText value="#{c.idEmpleado}"/></p:column>
            <p:column headerText="Cliente"><h:outputText value="#{c.idCliente}"/></p:column>
            <p:column headerText="Tipo"><h:outputText value="#{c.appointmentType}"/></p:column>
            <p:column headerText="Vehículo"><h:outputText value="#{c.idVehiculo}"/></p:column>
            <p:column headerText="Estado"><h:outputText value="#{c.status}"/></p:column>
            <p:column headerText="Acciones" style="width:170px">
                <p:commandButton icon="pi pi-pencil" title="Editar" styleClass="ui-button-info" actionListener="#{citaView.prepararEdicionCita(c)}" update=":dialogCitaForm"/>
                <p:commandButton icon="pi pi-trash" title="Eliminar" styleClass="ui-button-danger" actionListener="#{citaView.prepararEdicionCita(c)}" oncomplete="PF('confirmEliminarCita').show()" update=":confirmEliminarCitaForm"/>
            </p:column>
        </p:dataTable>
    </h:form>

    <p:dialog id="dialogCita" widgetVar="ventanaModalCita" modal="true" resizable="false" header="#{citaView.selected == null ? 'Nueva Cita' : 'Editar Cita'}">
        <h:form id="dialogCitaForm">
            <p:panelGrid columns="2" styleClass="ui-fluid" columnClasses="etq,val">
                <p:outputLabel value="Mecánico" for="mec" />
                <p:selectOneMenu id="mec" value="#{citaView.editIdEmpleado}" style="width:100%">
                    <f:selectItem itemLabel="-- Seleccione --" itemValue="" />
                    <f:selectItems value="#{citaView.mecanicos}" var="m" itemValue="#{m.idMecanico}" itemLabel="#{m.name} #{m.lastName}" />
                </p:selectOneMenu>

                <p:outputLabel value="Cliente" for="cli" />
                <p:selectOneMenu id="cli" value="#{citaView.editIdCliente}" style="width:100%">
                    <f:selectItem itemLabel="-- Seleccione --" itemValue="" />
                    <f:selectItems value="#{citaView.clientes}" var="c" itemValue="#{c.id_cliente}" itemLabel="#{c.name} #{c.lastName} (#{c.email})" />
                </p:selectOneMenu>

                <p:outputLabel value="Vehículo" for="veh" />
                <p:selectOneMenu id="veh" value="#{citaView.editIdVehiculo}" style="width:100%">
                    <f:selectItem itemLabel="-- Seleccione --" itemValue="" />
                    <f:selectItems value="#{citaView.vehiculos}" var="v" itemValue="#{v.id_vehiculo}" itemLabel="#{v.licensePlate} - #{v.model}" />
                </p:selectOneMenu>

                <p:outputLabel value="Tipo" for="tipo" />
                <p:inputText id="tipo" value="#{citaView.editAppointmentType}" required="true" />

                <p:outputLabel value="Fecha" for="fec"/>
                <p:calendar id="fec" value="#{citaView.editAppointmentDate}" pattern="yyyy-MM-dd" required="true"/>

                <p:outputLabel value="Estado" for="est"/>
                <p:selectOneMenu id="est" value="#{citaView.editStatus}" style="width:100%">
                    <f:selectItem itemLabel="pendiente" itemValue="pendiente" />
                    <f:selectItem itemLabel="en proceso" itemValue="en proceso" />
                    <f:selectItem itemLabel="finalizada" itemValue="finalizada" />
                    <f:selectItem itemLabel="cancelada" itemValue="cancelada" />
                </p:selectOneMenu>

                <p:outputLabel value="Comentario" for="com"/>
                <p:inputTextarea id="com" value="#{citaView.editComments}" rows="4" autoResize="true"/>
            </p:panelGrid>
            <p:separator/>
            <p:commandButton value="Guardar" icon="pi pi-save" styleClass="ui-button-success" actionListener="#{citaView.guardarCita}" update=":growlForm:growlMensajes :citasForm:tabla"/>
            <p:commandButton value="Cancelar" icon="pi pi-times" type="button" onclick="PF('ventanaModalCita').hide()"/>
        </h:form>
    </p:dialog>

    <p:dialog id="confirmEliminarCita" widgetVar="confirmEliminarCita" modal="true" resizable="false" closable="false" header="Confirmar">
        <h:form id="confirmEliminarCitaForm">
            <h:panelGroup rendered="#{not empty citaView.selected}"><h:outputText value="¿Eliminar cita '#{citaView.selected.id_cita}'?"/></h:panelGroup>
            <p:separator/>
            <p:commandButton value="Sí" icon="pi pi-check" styleClass="ui-button-danger" actionListener="#{citaView.eliminarCita}" update=":growlForm:growlMensajes :citasForm:tabla" oncomplete="PF('confirmEliminarCita').hide()"/>
            <p:commandButton value="No" icon="pi pi-times" type="button" onclick="PF('confirmEliminarCita').hide()"/>
        </h:form>
    </p:dialog>
</h:body>
</html>
